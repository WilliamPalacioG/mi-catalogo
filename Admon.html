<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Gesti√≥n de Pedidos</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <h2 class="text-lg font-bold mb-4 flex items-center gap-2">üìã Pedidos en preparaci√≥n</h2>
 <div id="status" class="mb-4 text-sm text-green-600">Backend OK ‚úÖ</div>

 
  <!-- üìå Contenedor responsive -->
  
  <div id="pedidos" class="grid gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4"></div>


  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md mx-4">
      <h3 class="text-xl font-bold mb-4">Observaciones</h3>
      <p id="obsText" class="mb-4"></p>
      <button onclick="cerrarModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg">Cerrar</button>
    </div>
  </div>

  <script>
    // üîó URL de tu backend
    const API_URL = "https://script.google.com/macros/s/AKfycbySeEPhj95vyF6BZtw8_HpM1lob4Za_h4APoM2H7xzctTpIXNCS9Q-YekCSIB993y9P/exec";

    async function cargarPedidos() {
      try {
        const res = await fetch(`${API_URL}?accion=pedidosPrep`);
        const data = await res.json();

        if (!data.ok) {
          document.getElementById("status").innerHTML = "‚ùå Error en backend";
          return;
        }

        document.getElementById("status").innerHTML = `Backend OK ‚úÖ`;
        renderPedidos(data.pedidos);
      } catch (err) {
        document.getElementById("status").innerHTML = "‚ùå Error cargando pedidos";
        console.error(err);
      }
    }

    function renderPedidos(pedidos) {
      const cont = document.getElementById("pedidos");
      cont.innerHTML = "";

      if (pedidos.length === 0) {
        cont.innerHTML = `<p class="text-gray-600">No hay pedidos en preparaci√≥n üöÄ</p>`;
        return;
      }

      pedidos.forEach(p => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded-xl shadow hover:shadow-lg transition flex flex-col";


        // Procesar items (quitar guion y precio)
        let itemsHTML = "";
        if (Array.isArray(p.items)) {
          itemsHTML = p.items.map(it => `
            <div class="bg-gray-100 p-2 rounded mb-2">
              <p><b>üçî ${it.nombre}</b></p>
              <p>Cantidad: ${it.cantidad}</p>
            </div>
          `).join("");
        } else {
          const partes = p.items.split(",");
          let lista = [];
          partes.forEach(item => {
            let sinPrecio = item.split(" - ")[0].trim(); // quitar precio
            const match = sinPrecio.match(/(.+)\sx(\d+)/i);
            if (match) {
              lista.push({ nombre: match[1].trim(), cantidad: Number(match[2]) });
            } else {
              lista.push({ nombre: sinPrecio, cantidad: 1 });
            }
          });
          itemsHTML = lista.map(it => `
            <div class="bg-gray-100 p-2 rounded mb-2">
              <p><b>üçî ${it.nombre}</b></p>
              <p>Cantidad: ${it.cantidad}</p>
            </div>
          `).join("");
        }

        // Tarjeta final
        card.innerHTML = `
          <h4 class="font-bold text-lg mb-2">Pedido #${p.numeroPedido} - ${p.fecha}</h4>
          ${itemsHTML}
          <div class="flex flex-col sm:flex-row gap-2">
            <button onclick="verObs('${p.observaciones || "Sin observaciones"}')" 
              class="px-3 py-1 bg-blue-500 text-white rounded-lg">Ver obs.</button>
            <button onclick="marcarPreparado(${p.numeroPedido})" 
              class="px-3 py-1 bg-green-500 text-white rounded-lg">Preparado</button>
          </div>
        `;
        cont.appendChild(card);
      });
    }

    function verObs(texto) {
      document.getElementById("obsText").innerText = texto;
      document.getElementById("modal").classList.remove("hidden");
    }

    function cerrarModal() {
      document.getElementById("modal").classList.add("hidden");
    }

    /** Actualiza el estado de un pedido a "Entregado" SOLO si est√° en "En preparaci√≥n" */
function marcarPedidoPreparado(numeroPedido) {
  const hoja = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Ventas");
  if (!hoja) throw new Error('No existe la hoja "Ventas".');

  const data = hoja.getDataRange().getValues();
  if (data.length < 2) return false;

  const headers   = data[0];
  const pedidoIdx = headers.indexOf("N¬∞ Pedido");
  const estadoIdx = headers.indexOf("Estado");

  if (pedidoIdx === -1 || estadoIdx === -1) throw new Error("Faltan columnas N¬∞ Pedido o Estado");

  // Normaliza acentos / may√∫sculas (soporta "En preparaci√≥n" y "En preparacion")
  const norm = s => String(s || "")
    .toLowerCase()
    .replace(/[√°√†√§√¢]/g,"a")
    .replace(/[√©√®√´√™]/g,"e")
    .replace(/[√≠√¨√Ø√Æ]/g,"i")
    .replace(/[√≥√≤√∂√¥]/g,"o")
    .replace(/[√∫√π√º√ª]/g,"u")
    .replace(/√±/g,"n")
    .trim();

  // Recorre de arriba hacia abajo, pero SOLO marca si est√° en preparaci√≥n
  for (let i = 1; i < data.length; i++) {
    const num = Number(data[i][pedidoIdx]);
    const estadoNorm = norm(data[i][estadoIdx]);

    if (num === numeroPedido && estadoNorm === "en preparacion") {
      hoja.getRange(i + 1, estadoIdx + 1).setValue("Entregado");

      // invalidar cache de pedidos
      try { CacheService.getScriptCache().remove(CACHE_KEYS.pedidos); } catch(e){}

      return true; // actualizado
    }
  }

  // No se encontr√≥ ese n√∫mero en estado "En preparaci√≥n"
  return false;
}


    // üöÄ Cargar pedidos al iniciar
    cargarPedidos();
    setInterval(cargarPedidos, 10000);
  </script>
</body>
</html>



