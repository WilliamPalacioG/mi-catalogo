<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n de Pedidos</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <h2 class="text-2xl font-bold mb-6">üìã Pedidos en preparaci√≥n</h2>

  <!-- Estado del backend -->
  <p id="backendStatus" class="text-sm mb-4 text-gray-600">‚è≥ Verificando backend...</p>

  <!-- Contenedor de pedidos -->
  <div id="pedidos" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"></div>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-lg w-96">
      <h3 class="text-xl font-bold mb-4">Observaciones</h3>
      <p id="obsText" class="mb-4"></p>
      <button onclick="cerrarModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg">Cerrar</button>
    </div>
  </div>

  <script>
    // üîó URL del backend (ya publicada)
    const API_URL = "https://script.google.com/macros/s/AKfycbx96Ms5d6js8BdDMuYIl6SwSbCcBVEh9WIA2Tqzh8IoNsTvfFjf8Xe-W09Ok5M8aiEw/exec";

    // ‚úÖ Verificar conexi√≥n con el backend
    async function checkBackend() {
      try {
        const res = await fetch(API_URL + "?accion=pedidosPrep");
        const data = await res.json();
        if (data.ok) {
          document.getElementById("backendStatus").innerHTML =
            '<span class="text-green-600">Backend OK ‚úÖ</span>';
        } else {
          document.getElementById("backendStatus").innerHTML =
            '<span class="text-red-600">Backend Error ‚ùå</span>';
        }
      } catch (err) {
        document.getElementById("backendStatus").innerHTML =
          '<span class="text-red-600">Backend sin conexi√≥n ‚ùå</span>';
      }
    }

    async function cargarPedidos() {
      try {
        const res = await fetch(`${API_URL}?accion=pedidosPrep`);
        const data = await res.json();

        if (!data.ok) {
          console.error("Error en backend:", data);
          return;
        }

        renderPedidos(data.pedidos);
      } catch (err) {
        console.error("Error cargando pedidos:", err);
      }
    }

    function renderPedidos(pedidos) {
      const cont = document.getElementById("pedidos");
      cont.innerHTML = "";

      if (pedidos.length === 0) {
        cont.innerHTML = `<p class="text-gray-600">No hay pedidos en preparaci√≥n üöÄ</p>`;
        return;
      }

      pedidos.forEach(p => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded-xl shadow hover:shadow-lg transition";

        let itemsHTML = "";

        if (Array.isArray(p.items)) {
          // Si ya viene como array JSON
          itemsHTML = p.items.map(it => `
            <div class="bg-gray-100 p-2 rounded mb-2">
              <p><b>üçî ${it.nombre}</b></p>
              <p>Cantidad: ${it.cantidad}</p>
            </div>
          `).join("");
        } else {
          // Si viene como texto "Hamburguesa Res x1 - $18000"
          const partes = p.items.split(",");
          let lista = [];

          partes.forEach(item => {
            let sinPrecio = item.split(" - ")[0].trim(); // quitar precio
            const match = sinPrecio.match(/(.+)\sx(\d+)/i);
            if (match) {
              lista.push({ nombre: match[1].trim(), cantidad: Number(match[2]) });
            } else {
              lista.push({ nombre: sinPrecio, cantidad: 1 });
            }
          });

          itemsHTML = lista.map(it => `
            <div class="bg-gray-100 p-2 rounded mb-2">
              <p><b>üçî ${it.nombre}</b></p>
              <p>Cantidad: ${it.cantidad}</p>
            </div>
          `).join("");
        }

        card.innerHTML = `
          <h4 class="font-bold text-lg mb-2">Pedido #${p.numeroPedido} - ${p.fecha}</h4>
          ${itemsHTML}
          <div class="flex gap-2">
            <button onclick="verObs('${p.observaciones || "Sin observaciones"}')" class="px-3 py-1 bg-blue-500 text-white rounded-lg">Ver obs.</button>
            <button onclick="marcarPreparado(${p.numeroPedido})" class="px-3 py-1 bg-green-500 text-white rounded-lg">Preparado</button>
          </div>
        `;
        cont.appendChild(card);
      });
    }

    function verObs(texto) {
      document.getElementById("obsText").innerText = texto;
      document.getElementById("modal").classList.remove("hidden");
    }

    function cerrarModal() {
      document.getElementById("modal").classList.add("hidden");
    }

    // ‚úÖ Enviar correctamente el pedido al backend
    async function marcarPreparado(nro) {
          if (!confirm(`¬øMarcar el pedido #${nro} como Preparado?`)) return;
        
          try {
            // üëá Usar FormData en vez de JSON
            const formData = new FormData();
            formData.append("accion", "marcarPreparado");
            formData.append("numeroPedido", nro);
        
            const res = await fetch(API_URL, {
              method: "POST",
              body: formData
            });
        
            const data = await res.json();
        
            if (data.ok) {
              alert(`‚úÖ Pedido #${nro} marcado como Preparado`);
              cargarPedidos();
            } else {
              alert("‚ùå Error: " + data.error);
            }
          } catch (err) {
            alert("Error en conexi√≥n: " + err);
          }
        }
 
    // üöÄ Iniciar
    checkBackend();
    cargarPedidos();
    setInterval(cargarPedidos, 10000);
  </script>
</body>
</html>

