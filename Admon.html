<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n de Pedidos</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-4 flex items-center gap-2">
      <span>üìã Pedidos en preparaci√≥n</span>
      <span id="status" class="text-sm font-normal"></span>
    </h1>
    <div id="pedidosContainer" class="grid md:grid-cols-2 gap-4"></div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxnUgAqNZInFrydQHUM2BtHrrIQ9qD-BD7rbCZWvwenU7yejGmkEnx4Ls75pB7lQ08E/exec";

    // Cargar pedidos
    async function cargarPedidos() {
      try {
        const res = await fetch(API_URL + "?accion=pedidosPrep");
        const data = await res.json();

        if (!data.ok) throw new Error("Error al obtener pedidos");

        document.getElementById("status").innerHTML = 
          `<span class='text-green-600'>Backend OK ‚úÖ</span>`;

        mostrarPedidos(data.pedidos);
      } catch (err) {
        document.getElementById("status").innerHTML =
          `<span class='text-red-600'>Error ‚ùå ${err.message}</span>`;
      }
    }

    // Mostrar pedidos en pantalla
    function mostrarPedidos(pedidos) {
      const cont = document.getElementById("pedidosContainer");
      cont.innerHTML = "";

      if (pedidos.length === 0) {
        cont.innerHTML = `<p class="text-gray-500">No hay pedidos en preparaci√≥n</p>`;
        return;
      }

      pedidos.forEach(p => {
        let itemsHTML = "";

        // üîπ Si items viene como array, lo mostramos bien
        if (Array.isArray(p.items)) {
          itemsHTML = p.items.map(i => `
            <div class="bg-gray-50 p-2 rounded">
              <b>üçî ${i.nombre}</b><br>
              Cantidad: ${i.qty || i.cantidad || 1}
            </div>
          `).join("");
        } else {
          // üîπ Si es string, lo mostramos plano
          itemsHTML = `<div class="bg-gray-50 p-2 rounded">${p.items}</div>`;
        }

        const pedidoHTML = `
          <div class="bg-white shadow rounded-xl p-4">
            <h2 class="font-bold mb-2">Pedido #${p.numeroPedido} - ${p.fecha}</h2>
            ${itemsHTML}
            <div class="mt-2 flex gap-2">
              <button onclick="verObs('${p.observaciones || ""}')"
                class="bg-blue-500 text-white px-3 py-1 rounded">Ver obs.</button>
              <button onclick="marcarPreparado(${p.numeroPedido})"
                class="bg-green-600 text-white px-3 py-1 rounded">Preparado</button>
            </div>
          </div>
        `;
        cont.innerHTML += pedidoHTML;
      });
    }

    // Mostrar observaciones
    function verObs(obs) {
      alert(obs && obs.trim() ? obs : "Sin observaciones");
    }

    // Marcar pedido como preparado
    async function marcarPreparado(numero) {
      if (!confirm(`¬øMarcar pedido #${numero} como preparado?`)) return;
      try {
        const res = await fetch(API_URL + "?accion=marcarPreparado&numeroPedido=" + numero, {
          method: "POST"
        });
        const data = await res.json();
        if (data.ok) {
          alert(`‚úÖ Pedido #${numero} marcado como preparado`);
          cargarPedidos();
        } else {
          alert("‚ùå Error: " + data.error);
        }
      } catch (err) {
        alert("‚ùå Error en conexi√≥n: " + err.message);
      }
    }

    // Recargar pedidos cada 5s
    setInterval(cargarPedidos, 5000);
    cargarPedidos();
  </script>
</body>
</html>
