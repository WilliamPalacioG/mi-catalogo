<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n de Pedidos</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <h2 class="text-2xl font-bold mb-2">üìã Pedidos en preparaci√≥n</h2>
  <p id="status" class="text-sm mb-6"></p>

  <!-- Contenedor de pedidos -->
  <div id="pedidos" class="flex flex-col gap-4"></div>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-lg w-96">
      <h3 class="text-xl font-bold mb-4">Observaciones</h3>
      <p id="obsText" class="mb-4"></p>
      <button onclick="cerrarModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg">Cerrar</button>
    </div>
  </div>

  <script>
    // üîó URL de tu backend
    const API_URL = "https://script.google.com/macros/s/AKfycbxnbRThEirvswBApsaiAfxY6MLz3YZbLRD7MEdRo9lvX-ELiUUXvIknUXxCNABnGSr8/exec";

    async function cargarPedidos() {
      try {
        const res = await fetch(`${API_URL}?accion=pedidosPrep`);
        const data = await res.json();

        if (!data.ok) {
          document.getElementById("status").innerHTML = "‚ùå Error en backend";
          return;
        }

        document.getElementById("status").innerHTML = `Backend OK ‚úÖ`;
        renderPedidos(data.pedidos);
      } catch (err) {
        document.getElementById("status").innerHTML = "‚ùå Error cargando pedidos";
        console.error(err);
      }
    }

    function renderPedidos(pedidos) {
      const cont = document.getElementById("pedidos");
      cont.innerHTML = "";

      if (pedidos.length === 0) {
        cont.innerHTML = `<p class="text-gray-600">No hay pedidos en preparaci√≥n üöÄ</p>`;
        return;
      }

      pedidos.forEach(p => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded-xl shadow hover:shadow-lg transition";

        // Procesar items (quitar guion y precio)
        let itemsHTML = "";
        if (Array.isArray(p.items)) {
          itemsHTML = p.items.map(it => `
            <div class="bg-gray-100 p-2 rounded mb-2">
              <p><b>üçî ${it.nombre}</b></p>
              <p>Cantidad: ${it.cantidad}</p>
            </div>
          `).join("");
        } else {
          const partes = p.items.split(",");
          let lista = [];
          partes.forEach(item => {
            let sinPrecio = item.split(" - ")[0].trim(); // quitar precio
            const match = sinPrecio.match(/(.+)\sx(\d+)/i);
            if (match) {
              lista.push({ nombre: match[1].trim(), cantidad: Number(match[2]) });
            } else {
              lista.push({ nombre: sinPrecio, cantidad: 1 });
            }
          });
          itemsHTML = lista.map(it => `
            <div class="bg-gray-100 p-2 rounded mb-2">
              <p><b>üçî ${it.nombre}</b></p>
              <p>Cantidad: ${it.cantidad}</p>
            </div>
          `).join("");
        }

        // Tarjeta final
        card.innerHTML = `
          <h4 class="font-bold text-lg mb-2">Pedido #${p.numeroPedido} - ${p.fecha}</h4>
          ${itemsHTML}
          <div class="flex gap-2">
            <button onclick="verObs('${p.observaciones || "Sin observaciones"}')" 
              class="px-3 py-1 bg-blue-500 text-white rounded-lg">Ver obs.</button>
            <button onclick="marcarPreparado(${p.numeroPedido})" 
              class="px-3 py-1 bg-green-500 text-white rounded-lg">Preparado</button>
          </div>
        `;
        cont.appendChild(card);
      });
    }

    function verObs(texto) {
      document.getElementById("obsText").innerText = texto;
      document.getElementById("modal").classList.remove("hidden");
    }

    function cerrarModal() {
      document.getElementById("modal").classList.add("hidden");
    }

    async function marcarPreparado(nro) {
      if (!confirm(`¬øMarcar el pedido #${nro} como Entregado?`)) return;
      try {
        const res = await fetch(API_URL + "?accion=marcarPreparado&numeroPedido=" + nro, {
          method: "POST"
        });
        const data = await res.json();

        if (data.ok) {
          alert(`‚úÖ Pedido #${nro} marcado como Entregado`);
          cargarPedidos(); // refresca lista
        } else {
          alert("‚ùå Error: " + data.error);
        }
      } catch (err) {
        alert("Error en conexi√≥n: " + err);
      }
    }

    // üöÄ Cargar pedidos al iniciar
    cargarPedidos();
    setInterval(cargarPedidos, 10000);
  </script>
</body>
</html>

