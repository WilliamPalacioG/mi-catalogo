<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cat√°logo Delidiosa</title>
<style>
  :root{
    --brand1:#ff9800;
    --brand2:#ff5722;
    --ok:#25D366;
    --text:#2f3640;
    --muted:#888;
    --card:#ffffff;
    --bg:#f5f6fa;
    --danger:#e74c3c;
    --pay-bg:#fff3cd;
    --pay-border:#ffa500;
    --success-bg:#e6ffed;
    --success-border:#28a745;
  }
  *{box-sizing:border-box}
  body{font-family:'Segoe UI', Arial, sans-serif;margin:0;color:var(--text);background:var(--bg);}
  header{background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff;text-align:center;padding:1rem;font-size:1.8rem;font-weight:700;position:sticky;top:0;z-index:10;}
  .controls{display:flex;flex-wrap:wrap;gap:.75rem;justify-content:center;padding:1rem;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05);position: sticky;
  top: 60px; /* justo debajo del header */
  z-index: 9;}
  .controls input,.controls select{padding:.65rem .9rem;border:1px solid #ddd;border-radius:8px;font-size:1rem;min-width:240px}
  .container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem;padding:1rem 1rem 5rem;max-width:1200px;margin:auto}
  .no-results{grid-column:1/-1;text-align:center;color:var(--muted);padding:1rem}
  .card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.08);display:flex;flex-direction:column;transition:transform .2s, box-shadow .2s}
  .card:hover{transform:translateY(-4px);box-shadow:0 10px 20px rgba(0,0,0,.12)}
  .card img{width:100%;height:180px;object-fit:cover;background:#f0f0f0}
  .card-body{padding:1rem;display:flex;flex-direction:column;gap:.4rem;flex:1}
  .card-body h3{margin:0;font-size:1.1rem}
  .desc{font-size:.9rem;color:#555;min-height:2.2em}
  .price{font-weight:700;color:#27ae60}
  .stock{font-size:.85rem;color:#16a085}
  .btn-add{margin-top:.4rem;padding:.65rem;border:0;border-radius:8px;cursor:pointer;background:var(--brand1);color:#fff;font-weight:700}
  .btn-add:hover{background:#e68900}
  #btn-pedido{position:fixed;right:16px;bottom:16px;z-index:1000;background:var(--ok);color:#fff;border:0;border-radius:999px;padding:.85rem 1.1rem;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.25);cursor:pointer}
  #contador{position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;font-size:.8rem;font-weight:700;line-height:1;padding:.3rem .45rem;border-radius:999px}
  .btn-container{position:fixed;right:16px;bottom:16px}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1100;padding:20px}
  .modal-content{background:#fff;border-radius:12px;max-width:480px;margin:auto;position:relative;padding:18px}
  .modal h3{margin:.2rem 0 1rem}
  .close{position:absolute;right:12px;top:8px;font-size:1.6rem;cursor:pointer;color:var(--danger)}
  .carrito-item{display:flex;align-items:center;justify-content:space-between;gap:.6rem;border-bottom:1px solid #eee;padding:.5rem 0}
  .qty{display:flex;align-items:center;gap:.3rem}
  .qty button{width:28px;height:28px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
  .btn-delete{border:0;background:var(--danger);color:#fff;border-radius:6px;padding:.35rem .5rem;cursor:pointer}
  .totals{margin-top:.6rem;border-top:2px dashed #eee;padding-top:.6rem;font-size:.95rem}
  .totals p{display:flex;justify-content:space-between;margin:.25rem 0}
  .btn-send{width:100%;margin-top:.8rem;background:var(--ok);color:#fff;border:0;border-radius:10px;padding:.85rem;font-weight:700;cursor:pointer}
  .badge{display:inline-block;font-size:.75rem;padding:.2rem .5rem;border-radius:999px;background:#ffe8d1;color:#7a3e00}
  .loading,.error{text-align:center;color:var(--muted);padding:1.2rem}
  .payment-section{background:var(--pay-bg);border:1px solid var(--pay-border);padding:10px;border-radius:8px;margin-top:12px}
  .payment-section label{display:block;margin-top:6px}
  .payment-section input[type="radio"]{margin-right:6px}
  .nequi-box{display:flex;align-items:center;gap:8px;margin-top:6px}
  .nequi-number{font-weight:700;color:#000;background:#fff;padding:4px 8px;border-radius:6px;border:1px solid #ccc}
  .copy-btn{padding:4px 8px;font-size:.8rem;background:var(--brand1);color:#fff;border:none;border-radius:6px;cursor:pointer}
  .copy-btn:hover{background:var(--brand2)}
  .direccion-input, .celular-input{width:100%;padding:6px;border:1px solid #ccc;border-radius:6px;margin-top:6px}
  .input-error{border-color:var(--danger)!important;background:#ffe5e5}
  .confirm-box{display:none;margin-top:12px;padding:10px;border:1px solid var(--success-border);background:var(--success-bg);border-radius:8px;color:#0e5f22;font-weight:600}
  .delivered-box{display:none;margin-top:12px;padding:10px;border:1px solid var(--success-border);background:#e8fff6;border-radius:8px;color:#0b644a;font-weight:600}
  .subtle{font-size:.9rem;color:#333;margin-top:4px}
  @media (min-width:768px){.card img{height:200px}}
</style>
</head>
<body>
<header>üçî Cat√°logo Delidiosa</header>

<div class="controls">
  <input type="text" id="search" placeholder="Buscar producto...">
  <select id="filter-category"><option value="">Todas las categor√≠as</option></select>
</div>

<div id="state" class="loading">Cargando productos‚Ä¶</div>
<div class="container" id="product-container" style="display:none;"></div>

<div class="btn-container">
  <button id="btn-pedido" onclick="abrirCarrito()">üì¶ Pedido <span id="contador">0</span></button>
</div>

<div id="modal-carrito" class="modal" aria-hidden="true">
  <div class="modal-content">
    <span class="close" onclick="cerrarCarrito()">&times;</span>
    <h3>üõí Tu pedido</h3>
    <div id="lista-carrito"></div>

    <div class="totals">
      <p><span>Subtotal</span><strong>$<span id="subtotal-carrito">0</span></strong></p>
      <p><span>Domicilio</span><strong class="badge" id="domicilio-label">$0</strong></p>
      <p><span>Total</span><strong>$<span id="total-carrito">0</span></strong></p>
    </div>

    <!-- Direcci√≥n y Celular -->
    <label><strong>üìç Direcci√≥n de entrega</strong></label>
    <input type="text" id="direccion" class="direccion-input" placeholder="Escribe tu direcci√≥n">

    <label style="margin-top:8px;"><strong>üì± Celular (Colombia)</strong></label>
    <input type="tel" id="celular" class="celular-input" placeholder="10 d√≠gitos (ej. 3XXXXXXXXX)" maxlength="10">

    <!-- M√©todo de pago -->
    <div class="payment-section">
      <strong>üí≥ M√©todo de pago</strong>
      <label><input type="radio" name="metodoPago" value="Efectivo"> Efectivo</label>
      <div id="efectivo-box" style="display:none;">
        <label>Monto con el que paga:</label>
        <input type="number" id="monto-efectivo" min="0" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:6px;">
      </div>

      <label><input type="radio" name="metodoPago" value="Nequi"> Nequi</label>
      <div id="nequi-box" class="nequi-box" style="display:none;">
        <span class="nequi-number" id="nequi-numero">0000000000</span>
        <button class="copy-btn" onclick="copiarNequi()">üìã Copiar</button>
      </div>
    </div>

    <!-- Confirmaciones / Estado -->
    <div id="confirmacion" class="confirm-box"></div>
    <div id="entregado" class="delivered-box"></div>
    <div id="cola-info" class="subtle" style="display:none;"></div>

    <button class="btn-send" onclick="enviarPedido()">Enviar por WhatsApp</button>
  </div>
</div>

<footer style="text-align:center;padding:1rem;background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff;margin-top:1rem;">
  ¬© 2025 - SWP Delidiosa Wpalacio
</footer>

<script>
  // üîó Reemplaza con tu URL de Web App (Apps Script)
  const API_URL = "https://script.google.com/macros/s/AKfycby8ZYOKY_FBVj5LPuaBD_9guWVW-pdipHRZ4v3_OfCJr8rqjvt32Wtp2yYR6x10KJ0K/exec";
  const NUMERO_WHATSAPP = "573147569934"; // destino para recibir el pedido por WhatsApp

  let productos = [];
  let COSTO_DOMICILIO = 0;
  let NUMERO_NEQUI = "";
  let carrito = JSON.parse(localStorage.getItem("carrito")) || [];
  let ultimoEntregado = 0;
  let numeroPedidoCliente = null;
  let pollTimer = null;

  const fmt = n => Number(n||0).toLocaleString();
  const isNoDisponible = v => (typeof v === 'string' && v.trim().toLowerCase() === 'no disponible') || Number(v) === 0;

  async function cargarProductos(){
    const state = document.getElementById('state');
    const grid = document.getElementById('product-container');
    state.style.display = 'block';
    grid.style.display = 'none';
    try{
      const res = await fetch(API_URL, {cache:"no-store"});
      const data = await res.json();
      productos = data.productos || [];
      const cfg = data.config || {};
      COSTO_DOMICILIO = Number(cfg.Domicilio || 0);
      NUMERO_NEQUI = cfg.Nequi || cfg.NEQUI || "";
      ultimoEntregado = data.pedidos ? (data.pedidos.ultimoEntregado || 0) : 0;

      document.getElementById('domicilio-label').textContent = `$${fmt(COSTO_DOMICILIO)}`;
      document.getElementById('nequi-numero').textContent = NUMERO_NEQUI;

      mostrarCategorias();
      mostrarProductos();
      actualizarCarrito();

      state.style.display = 'none';
      grid.style.display = 'grid';
    }catch(e){
      console.error(e);
      state.textContent = "Error cargando productos.";
    }
  }

  function mostrarCategorias(){
    const select=document.getElementById("filter-category");
    select.innerHTML='<option value="">Todas las categor√≠as</option>';
    [...new Set(productos.map(p=>p.Categor√≠a).filter(Boolean))].sort().forEach(cat=>{
      const o=document.createElement("option");o.value=cat;o.textContent=cat;select.appendChild(o);
    });
  }

  function mostrarProductos(){
    const cont=document.getElementById("product-container");
    cont.innerHTML="";
    const busqueda=(document.getElementById("search").value||"").toLowerCase();
    const catSel=document.getElementById("filter-category").value;
    const filtrados=productos.filter(prod=>{
      return (prod.Nombre||"").toLowerCase().includes(busqueda)
        && (!catSel || prod.Categor√≠a===catSel)
        && !isNoDisponible(prod.Stock);
    });
    if(!filtrados.length){cont.innerHTML=`<div class="no-results">‚ö† No se encontraron resultados</div>`;return;}
    filtrados.forEach(prod=>{
      const precio=Number(prod.Precio||0);
      cont.innerHTML+=`
        <div class="card">
          <img src="${prod.ImagenURL||'https://via.placeholder.com/600x400?text=Producto'}" alt="${prod.Nombre||''}">
          <div class="card-body">
            <h3>${prod.Nombre||''}</h3>
            <p class="desc">${prod.Descripci√≥n||''}</p>
            <p class="price">$${fmt(precio)}</p>
            <p class="stock">Stock: ${prod.Stock??''}</p>
            <button class="btn-add" onclick="agregarAlCarrito('${(prod.Nombre||'').replace(/'/g,"\\'")}',${precio})">Agregar</button>
          </div>
        </div>
      `;
    });
  }

  function agregarAlCarrito(nombre,precio){
    const idx=carrito.findIndex(i=>i.nombre===nombre);
    if(idx>=0)carrito[idx].qty+=1;
    else carrito.push({nombre,precio:Number(precio||0),qty:1});
    persistirCarrito();actualizarCarrito();
  }

  function cambiarCantidad(i,d){
    carrito[i].qty=Math.max(1,(carrito[i].qty||1)+d);
    persistirCarrito();actualizarCarrito();
  }

  function eliminarDelCarrito(i){carrito.splice(i,1);persistirCarrito();actualizarCarrito();}
  function persistirCarrito(){localStorage.setItem("carrito",JSON.stringify(carrito));}

  function actualizarCarrito(){
    document.getElementById("contador").textContent=carrito.reduce((a,i)=>a+i.qty,0);
    const lista=document.getElementById("lista-carrito");
    const sub=carrito.reduce((s,i)=>s+i.precio*i.qty,0);
    const total=sub+Number(COSTO_DOMICILIO||0);
    lista.innerHTML=carrito.length===0?`<p class="no-results">Tu carrito est√° vac√≠o.</p>`:
      carrito.map((it,idx)=>`
        <div class="carrito-item">
          <div><strong>${it.nombre}</strong><br/><small>$${fmt(it.precio)} c/u</small></div>
          <div class="qty">
            <button onclick="cambiarCantidad(${idx},-1)">‚àí</button>
            <span>${it.qty}</span>
            <button onclick="cambiarCantidad(${idx},1)">+</button>
            <button class="btn-delete" onclick="eliminarDelCarrito(${idx})">üóëÔ∏è</button>
          </div>
        </div>`).join("");
    document.getElementById("subtotal-carrito").textContent=fmt(sub);
    document.getElementById("total-carrito").textContent=fmt(total);
  }

  function abrirCarrito(){
    // reset mensajes
    document.getElementById("confirmacion").style.display="none";
    document.getElementById("entregado").style.display="none";
    document.getElementById("cola-info").style.display="none";
    document.getElementById("modal-carrito").style.display="block";
  }
  function cerrarCarrito(){document.getElementById("modal-carrito").style.display="none";}

  function copiarNequi(){navigator.clipboard.writeText(NUMERO_NEQUI).then(()=>alert("N√∫mero Nequi copiado"));}

  function validarCelular10(n){
    // Colombia m√≥vil: 10 d√≠gitos iniciando por 3
    return /^[3]\d{9}$/.test((n||"").trim());
  }

  async function registrarVenta(payload){
    try{
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' }, // evita preflight en Apps Script
        body: JSON.stringify(payload)
      });
      return await res.json();
    }catch(e){return { ok:false, error:String(e) }}
  }

  async function enviarPedido(){
    if(carrito.length===0){alert("‚ö†Ô∏è No has agregado productos.");return;}

    // Validaci√≥n direcci√≥n
    const direccion = document.getElementById("direccion");
    if(!direccion.value.trim()){
      direccion.classList.add("input-error");
      alert("‚ö†Ô∏è Debes ingresar la direcci√≥n.");
      return;
    } else {direccion.classList.remove("input-error");}

    // Validaci√≥n celular
    const celular = document.getElementById("celular");
    if(!validarCelular10(celular.value)){
      celular.classList.add("input-error");
      alert("‚ö†Ô∏è Ingresa un celular v√°lido de 10 d√≠gitos que inicie por 3.");
      return;
    } else {celular.classList.remove("input-error");}

    // M√©todo de pago
    const metodo=document.querySelector('input[name="metodoPago"]:checked');
    if(!metodo){alert("‚ö†Ô∏è Selecciona un m√©todo de pago.");return;}

    if(metodo.value==="Efectivo"){
      const monto=document.getElementById("monto-efectivo").value;
      if(!monto){alert("‚ö†Ô∏è Ingresa con cu√°nto pagas.");return;}
    }
    if(metodo.value==="Nequi"){
      if(!confirm("Recuerda enviar el soporte de pago despu√©s de que confirmemos para iniciar tu pedido")) return;
    }

    // Totales
    const sub=carrito.reduce((s,i)=>s+i.precio*i.qty,0);
    const total=sub+Number(COSTO_DOMICILIO||0);

    // Registrar en hoja (y obtener N¬∞ Pedido)
    const payload = {
      items: carrito.map(i => ({nombre: i.nombre, qty: i.qty, precio: i.precio, subtotal: i.precio*i.qty})),
      subtotal: sub,
      domicilio: Number(COSTO_DOMICILIO||0),
      total: total,
      metodoPago: metodo.value,
      montoEfectivo: metodo.value === 'Efectivo' ? Number(document.getElementById('monto-efectivo').value || 0) : null,
      nequi: metodo.value === 'Nequi' ? NUMERO_NEQUI : null,
      direccion: direccion.value.trim(),
      celular: celular.value.trim(),
      whatsapp: NUMERO_WHATSAPP
    };

    const resp = await registrarVenta(payload);
    if(!resp.ok){
      alert("No se pudo registrar el pedido. Intenta de nuevo.");
      return;
    }

    numeroPedidoCliente = resp.numeroPedido || null;

    // Mensaje WhatsApp
    let mensaje=`üìù Pedido N¬∞${numeroPedidoCliente}\n\nHola, quiero hacer el siguiente pedido:\n\n`;
    carrito.forEach(it=>mensaje+=`‚Ä¢ ${it.nombre} x${it.qty} - $${fmt(it.precio*it.qty)}\n`);
    mensaje+=`\nüìç Direcci√≥n: ${direccion.value.trim()}`;
    mensaje+=`\nüì± Celular: ${celular.value.trim()}`;
    mensaje+=`\nSubtotal: $${fmt(sub)}\nDomicilio: $${fmt(COSTO_DOMICILIO)}\nüí∞ Total: $${fmt(total)}`;
    if (metodo.value === "Efectivo") {
      const monto = document.getElementById("monto-efectivo").value;
      mensaje += `\nüíµ Pago con: $${fmt(monto)}`;
    } else {
      mensaje += `\nüì± Pago por Nequi a este n√∫mero: ${NUMERO_NEQUI}`;
    }
    window.open(`https://wa.me/${NUMERO_WHATSAPP}?text=${encodeURIComponent(mensaje)}`,"_blank");

    // UI de confirmaci√≥n bonita
    const conf = document.getElementById("confirmacion");
    conf.style.display = "block";
    conf.innerHTML = `‚úÖ Tu pedido N¬∞${numeroPedidoCliente} est√° en preparaci√≥n.`;

    const cola = document.getElementById("cola-info");
    cola.style.display = "block";
    cola.textContent = `üçΩÔ∏è En cocina vamos hasta el N¬∞${ultimoEntregado}.`;

    // limpiar carrito y campo efectivo
    carrito=[]; persistirCarrito(); actualizarCarrito();
    document.getElementById("monto-efectivo").value = "";

    // Iniciar/renovar polling
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(verificarEstadoPedido, 30000);
  }

  async function verificarEstadoPedido(){
    if(!numeroPedidoCliente) return;
    try{
      const res = await fetch(`${API_URL}?numeroPedido=${numeroPedidoCliente}`, {cache:"no-store"});
      const data = await res.json();
      // Actualiza "hasta N¬∞" por si cambi√≥
      if (data && data.pedidos) {
        ultimoEntregado = data.pedidos.ultimoEntregado || ultimoEntregado;
        const cola = document.getElementById("cola-info");
        if (cola.style.display !== "none") {
          cola.textContent = `üçΩÔ∏è En cocina vamos hasta el N¬∞${ultimoEntregado}.`;
        }
      }
      if(data.pedidos && data.pedidos.estadoCliente === "Entregado"){
        const ok = document.getElementById("entregado");
        ok.style.display = "block";
        ok.innerHTML = `üéâ Tu pedido N¬∞${numeroPedidoCliente} fue ENTREGADO. ¬°Gracias!`;

        // Reset de la app a los 3 segundos
        setTimeout(()=>{
          numeroPedidoCliente = null;
          document.getElementById("confirmacion").style.display="none";
          document.getElementById("entregado").style.display="none";
          document.getElementById("cola-info").style.display="none";
          document.getElementById("direccion").value = "";
          document.getElementById("celular").value = "";
          const efectivo = document.getElementById("monto-efectivo");
          if (efectivo) efectivo.value = "";
          const radios = document.querySelectorAll('input[name="metodoPago"]');
          radios.forEach(r=>r.checked=false);
          document.getElementById("efectivo-box").style.display="none";
          document.getElementById("nequi-box").style.display="none";
          cerrarCarrito();
          if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
        }, 3000);
      }
    }catch(e){ console.warn("No se pudo verificar estado:", e); }
  }

  // Eventos UI
  document.getElementById("search").addEventListener("input",mostrarProductos);
  document.getElementById("filter-category").addEventListener("change",mostrarProductos);
  document.querySelector('input[value="Efectivo"]').addEventListener("change",()=>{
    document.getElementById("efectivo-box").style.display="block";
    document.getElementById("nequi-box").style.display="none";
  });
  document.querySelector('input[value="Nequi"]').addEventListener("change",()=>{
    document.getElementById("nequi-box").style.display="flex";
    document.getElementById("efectivo-box").style.display="none";
  });

  // Init
  cargarProductos();
</script>
</body>
</html>

