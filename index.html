<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cat√°logo Delidiosa</title>
<style>
  :root{
    --brand1:#ff9800;
    --brand2:#ff5722;
    --ok:#25D366;
    --text:#2f3640;
    --muted:#888;
    --card:#ffffff;
    --bg:#f5f6fa;
    --danger:#e74c3c;
    --pay-bg:#fff3cd;
    --pay-border:#ffa500;
  }
  *{box-sizing:border-box}
  body{font-family:'Segoe UI', Arial, sans-serif;margin:0;color:var(--text);background:var(--bg);}
  header{background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff;text-align:center;padding:1rem;font-size:1.8rem;font-weight:700;position:sticky;top:0;z-index:1000;}
  #pedido-banner{background:#fff3cd;border:1px solid #ffa500;color:#000;text-align:center;padding:.5rem;font-weight:700;position:sticky;top:64px;z-index:999;}
  .controls{display:flex;flex-wrap:wrap;gap:.75rem;justify-content:center;padding:1rem;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05);position:sticky;top:120px;z-index:998;}
  .controls input,.controls select{padding:.65rem .9rem;border:1px solid #ddd;border-radius:8px;font-size:1rem;min-width:240px}
  .container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem;padding:1rem 1rem 5rem;max-width:1200px;margin:auto}
  .no-results{grid-column:1/-1;text-align:center;color:var(--muted);padding:1rem}
  .card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.08);display:flex;flex-direction:column;transition:transform .2s, box-shadow .2s}
  .card:hover{transform:translateY(-4px);box-shadow:0 10px 20px rgba(0,0,0,.12)}
  .card img{width:100%;height:180px;object-fit:cover;background:#f0f0f0}
  .card-body{padding:1rem;display:flex;flex-direction:column;gap:.4rem;flex:1}
  .card-body h3{margin:0;font-size:1.1rem}
  .desc{font-size:.9rem;color:#555;min-height:2.2em}
  .price{font-weight:700;color:#27ae60}
  .stock{font-size:.85rem;color:#16a085}
  .btn-add{margin-top:.4rem;padding:.65rem;border:0;border-radius:8px;cursor:pointer;background:var(--brand1);color:#fff;font-weight:700}
  .btn-add:hover{background:#e68900}
  #btn-pedido{position:fixed;right:16px;bottom:16px;z-index:1000;background:var(--ok);color:#fff;border:0;border-radius:999px;padding:.85rem 1.1rem;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.25);cursor:pointer}
  #contador{position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;font-size:.8rem;font-weight:700;line-height:1;padding:.3rem .45rem;border-radius:999px}
  .btn-container{position:fixed;right:16px;bottom:16px}

  /* === Bot√≥n flotante de seguimiento (nuevo) === */
  #btn-seguimiento{
    position:fixed;right:16px;bottom:84px; /* arriba del bot√≥n de carrito */
    z-index:1000;background:var(--brand1);color:#fff;border:0;border-radius:999px;
    width:56px;height:56px;font-size:26px;line-height:56px;text-align:center;
    box-shadow:0 6px 16px rgba(0,0,0,.25);cursor:pointer
  }
  #btn-seguimiento:hover{background:#e68900}

  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1100;padding:20px}
  .modal-content{background:#fff;border-radius:12px;max-width:460px;margin:auto;position:relative;padding:18px}
  .modal h3{margin:.2rem 0 1rem}
  .close{position:absolute;right:12px;top:8px;font-size:1.6rem;cursor:pointer;color:var(--danger)}
  .carrito-item{display:flex;align-items:center;justify-content:space-between;gap:.6rem;border-bottom:1px solid #eee;padding:.5rem 0}
  .qty{display:flex;align-items:center;gap:.3rem}
  .qty button{width:28px;height:28px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
  .btn-delete{border:0;background:var(--danger);color:#fff;border-radius:6px;padding:.35rem .5rem;cursor:pointer}
  .totals{margin-top:.6rem;border-top:2px dashed #eee;padding-top:.6rem;font-size:.95rem}
  .totals p{display:flex;justify-content:space-between;margin:.25rem 0}
  .btn-send{width:100%;margin-top:.8rem;background:var(--ok);color:#fff;border:0;border-radius:10px;padding:.85rem;font-weight:700;cursor:pointer}
  .badge{display:inline-block;font-size:.75rem;padding:.2rem .5rem;border-radius:999px;background:#ffe8d1;color:#7a3e00}
  .loading,.error{text-align:center;color:var(--muted);padding:1.2rem}
  .payment-section{background:var(--pay-bg);border:1px solid var(--pay-border);padding:10px;border-radius:8px;margin-top:12px}
  .payment-section label{display:block;margin-top:6px}
  .payment-section input[type="radio"]{margin-right:6px}
  .nequi-box{display:flex;align-items:center;gap:8px;margin-top:6px}
  .nequi-number{font-weight:700;color:#000;background:#fff;padding:4px 8px;border-radius:6px;border:1px solid #ccc}
  .copy-btn{padding:4px 8px;font-size:.8rem;background:var(--brand1);color:#fff;border:none;border-radius:6px;cursor:pointer}
  .copy-btn:hover{background:var(--brand2)}
  .direccion-input{width:100%;padding:6px;border:1px solid #ccc;border-radius:6px;margin-top:6px}
  .direccion-error{border-color:var(--danger)!important;background:#ffe5e5}
  .celular-input{width:100%;padding:6px;border:1px solid #ccc;border-radius:6px;margin-top:6px}
</style>
</head>
<body>
<header>üçî Cat√°logo Delidiosa</header>

<div id="pedido-banner">Cargando estado de pedidos...</div>

<div class="controls">
  <input type="text" id="search" placeholder="Buscar producto...">
  <select id="filter-category"><option value="">Todas las categor√≠as</option></select>
</div>

<div id="state" class="loading">Cargando productos‚Ä¶</div>
<div class="container" id="product-container" style="display:none;"></div>

<!-- Bot√≥n flotante de seguimiento (nuevo) -->
<button id="btn-seguimiento" title="Seguimiento de pedido" onclick="abrirSeguimiento()">üì¶</button>

<div class="btn-container">
  <button id="btn-pedido" onclick="abrirCarrito()">üì¶ Pedido <span id="contador">0</span></button>
</div>

<div id="modal-carrito" class="modal" aria-hidden="true">
  <div class="modal-content">
    <span class="close" onclick="cerrarCarrito()">&times;</span>
    <h3>üõí Tu pedido</h3>
    <div id="lista-carrito"></div>
    <div class="totals">
      <p><span>Subtotal</span><strong>$<span id="subtotal-carrito">0</span></strong></p>
      <p><span>Domicilio</span><strong class="badge" id="domicilio-label">$0</strong></p>
      <p><span>Total</span><strong>$<span id="total-carrito">0</span></strong></p>
    </div>

    <!-- Direcci√≥n -->
    <label><strong>üìç Direcci√≥n de entrega</strong></label>
    <input type="text" id="direccion" class="direccion-input" placeholder="Escribe tu direcci√≥n">

    <!-- Celular -->
    <label><strong>üì± Celular</strong></label>
    <input type="tel" id="celular" class="celular-input" placeholder="Ej: 3001234567" maxlength="10">

    <!-- M√©todo de pago -->
    <div class="payment-section">
      <strong>üí≥ M√©todo de pago</strong>
      <label><input type="radio" name="metodoPago" value="Efectivo"> Efectivo</label>
      <div id="efectivo-box" style="display:none;">
        <label>Monto con el que paga:</label>
        <input type="number" id="monto-efectivo" min="0" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:6px;">
      </div>
      <label><input type="radio" name="metodoPago" value="Nequi"> Nequi</label>
      <div id="nequi-box" class="nequi-box" style="display:none;">
        <span class="nequi-number" id="nequi-numero">0000000000</span>
        <button class="copy-btn" onclick="copiarNequi()">üìã Copiar</button>
      </div>
    </div>

    <button class="btn-send" onclick="enviarPedido()">Enviar por WhatsApp</button>
  </div>
</div>

<!-- Modal de seguimiento (nuevo) -->
<div id="modal-seguimiento" class="modal" aria-hidden="true">
  <div class="modal-content">
    <span class="close" onclick="cerrarSeguimiento()">&times;</span>
    <h3>üì¶ Seguimiento de pedido</h3>
    <label for="input-num-pedido"><strong>N√∫mero de pedido</strong></label>
    <input type="number" id="input-num-pedido" class="direccion-input" placeholder="Ej: 12">
    <button class="btn-send" onclick="consultarEstadoPedido()">Consultar estado</button>
    <div id="resultado-seguimiento" class="loading" style="display:none;"></div>
  </div>
</div>

<footer style="text-align:center;padding:1rem;background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff;margin-top:1rem;">
  ¬© 2025 - SWP Delidiosa Wpalacio
</footer>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwOuwIMSlOq4kqM61V7EuU2uKfOHY1oPp9k67GkMXplsg_JWMzICp-kCcTpCnEXi79i/exec";
const NUMERO_WHATSAPP = "573147569934";

let productos = [];
let COSTO_DOMICILIO = 0;
let NUMERO_NEQUI = "";
let carrito = JSON.parse(localStorage.getItem("carrito")) || [];
let pedidoCliente = null; // guardar√° el n√∫mero de pedido del cliente
const fmt = n => Number(n||0).toLocaleString();
const isNoDisponible = v => (typeof v === 'string' && v.trim().toLowerCase() === 'no disponible') || Number(v) === 0;

async function cargarProductos(){
  const res = await fetch(API_URL,{cache:"no-store"});
  const data = await res.json();
  productos = data.productos || [];
  COSTO_DOMICILIO = Number((data.config && data.config.Domicilio) || 0);
  NUMERO_NEQUI = (data.config && (data.config.Nequi || data.config.NEQUI)) || "";
  document.getElementById("nequi-numero").textContent = NUMERO_NEQUI;
  document.getElementById('domicilio-label').textContent = `$${fmt(COSTO_DOMICILIO)}`;
  mostrarCategorias();mostrarProductos();actualizarCarrito();
  document.getElementById('state').style.display="none";
  document.getElementById('product-container').style.display="grid";
  actualizarBanner(); // primer estado
}

function mostrarCategorias(){
  const select=document.getElementById("filter-category");
  select.innerHTML='<option value="">Todas las categor√≠as</option>';
  [...new Set(productos.map(p=>p.Categor√≠a).filter(Boolean))].sort().forEach(cat=>{
    const o=document.createElement("option");o.value=cat;o.textContent=cat;select.appendChild(o);
  });
}

function mostrarProductos(){
  const cont=document.getElementById("product-container");
  cont.innerHTML="";
  const busqueda=(document.getElementById("search").value||"").toLowerCase();
  const catSel=document.getElementById("filter-category").value;
  const filtrados=productos.filter(prod=>{
    return (prod.Nombre||"").toLowerCase().includes(busqueda)
      && (!catSel || prod.Categor√≠a===catSel)
      && !isNoDisponible(prod.Stock);
  });
  if(!filtrados.length){cont.innerHTML=`<div class="no-results">‚ö† No se encontraron resultados</div>`;return;}
  filtrados.forEach(prod=>{
    const precio=Number(prod.Precio||0);
    cont.innerHTML+=`
      <div class="card">
        <img src="${prod.ImagenURL||'https://via.placeholder.com/600x400?text=Producto'}" alt="${prod.Nombre||''}">
        <div class="card-body">
          <h3>${prod.Nombre||''}</h3>
          <p class="desc">${prod.Descripci√≥n||''}</p>
          <p class="price">$${fmt(precio)}</p>
          <p class="stock">Stock: ${prod.Stock??''}</p>
          <button class="btn-add" onclick="agregarAlCarrito('${(prod.Nombre||'').replace(/'/g,"\\'")}',${precio})">Agregar</button>
        </div>
      </div>
    `;
  });
}

function agregarAlCarrito(nombre,precio){
  const idx=carrito.findIndex(i=>i.nombre===nombre);
  if(idx>=0)carrito[idx].qty+=1;
  else carrito.push({nombre,precio:Number(precio||0),qty:1});
  persistirCarrito();actualizarCarrito();
}

function cambiarCantidad(i,d){carrito[i].qty=Math.max(1,(carrito[i].qty||1)+d);persistirCarrito();actualizarCarrito();}
function eliminarDelCarrito(i){carrito.splice(i,1);persistirCarrito();actualizarCarrito();}
function persistirCarrito(){localStorage.setItem("carrito",JSON.stringify(carrito));}

function actualizarCarrito(){
  document.getElementById("contador").textContent=carrito.reduce((a,i)=>a+i.qty,0);
  const lista=document.getElementById("lista-carrito");
  const sub=carrito.reduce((s,i)=>s+i.precio*i.qty,0);
  const total=sub+Number(COSTO_DOMICILIO||0);
  lista.innerHTML=carrito.length===0?`<p class="no-results">Tu carrito est√° vac√≠o.</p>`:
    carrito.map((it,idx)=>`
      <div class="carrito-item">
        <div><strong>${it.nombre}</strong><br/><small>$${fmt(it.precio)} c/u</small></div>
        <div class="qty">
          <button onclick="cambiarCantidad(${idx},-1)">‚àí</button>
          <span>${it.qty}</span>
          <button onclick="cambiarCantidad(${idx},1)">+</button>
          <button class="btn-delete" onclick="eliminarDelCarrito(${idx})">üóëÔ∏è</button>
        </div>
      </div>`).join("");
  document.getElementById("subtotal-carrito").textContent=fmt(sub);
  document.getElementById("total-carrito").textContent=fmt(total);
}

function abrirCarrito(){document.getElementById("modal-carrito").style.display="block";}
function cerrarCarrito(){document.getElementById("modal-carrito").style.display="none";}
function copiarNequi(){navigator.clipboard.writeText(NUMERO_NEQUI).then(()=>alert("N√∫mero Nequi copiado"));}

async function registrarVenta(payload){
  try{
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload)
    });
    return await res.json();
  }catch(e){return { ok:false, error:String(e) }}
}

async function enviarPedido(){
  if(carrito.length===0){alert("‚ö†Ô∏è No has agregado productos.");return;}
  const direccion=document.getElementById("direccion");
  if(!direccion.value.trim()){direccion.classList.add("direccion-error");alert("‚ö†Ô∏è Debes ingresar la direcci√≥n.");return;}
  else {direccion.classList.remove("direccion-error");}

  const celular=document.getElementById("celular").value.trim();
  if(!/^[0-9]{10}$/.test(celular)){alert("‚ö†Ô∏è Ingresa un celular v√°lido de 10 d√≠gitos.");return;}

  const metodo=document.querySelector('input[name="metodoPago"]:checked');
  if(!metodo){alert("‚ö†Ô∏è Selecciona un m√©todo de pago.");return;}

  if(metodo.value==="Efectivo"){
    const monto=document.getElementById("monto-efectivo").value;
    if(!monto){alert("‚ö†Ô∏è Ingresa con cu√°nto pagas.");return;}
  }
  if(metodo.value==="Nequi"){
    if(!confirm("Recuerda enviar el soporte de pago despu√©s de que confirmemos para iniciar tu pedido")) return;
  }

  const sub=carrito.reduce((s,i)=>s+i.precio*i.qty,0);
  const total=sub+Number(COSTO_DOMICILIO||0);

  const payload = {
    items: carrito.map(i => ({nombre: i.nombre, qty: i.qty, precio: i.precio, subtotal: i.precio*i.qty})),
    subtotal: sub,
    domicilio: Number(COSTO_DOMICILIO||0),
    total: total,
    metodoPago: metodo.value,
    montoEfectivo: metodo.value === 'Efectivo' ? Number(document.getElementById('monto-efectivo').value||0) : "",
    nequi: metodo.value === 'Nequi' ? NUMERO_NEQUI : "",
    direccion: direccion.value.trim(),
    celular: celular
  };

  const resp = await registrarVenta(payload);
  if(resp.ok){
    pedidoCliente = resp.numeroPedido;

    // construir mensaje para WhatsApp
    let mensaje = `üìù Pedido N¬∞${resp.numeroPedido}\n\n`;
    mensaje += carrito.map(i => `- ${i.qty} x ${i.nombre} ($${fmt(i.precio)} c/u)`).join("\n");
    mensaje += `\n\nüìç Direcci√≥n: ${payload.direccion}`;
    mensaje += `\nüì± Celular: ${payload.celular}`;
    mensaje += `\nüí≥ Pago: ${payload.metodoPago}`;
    if(payload.metodoPago === "Efectivo"){
      mensaje += `\nüíµ Con: $${fmt(payload.montoEfectivo)}`;
    }
    if(payload.metodoPago === "Nequi"){
      mensaje += `\nüì≤ Nequi: ${payload.nequi}`;
    }
    mensaje += `\n\nSubtotal: $${fmt(sub)}\nDomicilio: $${fmt(payload.domicilio)}\n\nTOTAL: $${fmt(total)}`;

    // abrir WhatsApp con encodeURIComponent
    let url = `https://wa.me/${NUMERO_WHATSAPP}?text=${encodeURIComponent(mensaje)}`;
    window.open(url, "_blank");

    alert(`‚úÖ Tu pedido N¬∞${resp.numeroPedido} est√° en preparaci√≥n`);
    carrito=[];persistirCarrito();actualizarCarrito();cerrarCarrito();
    document.getElementById("monto-efectivo").value="";
    actualizarBanner();
  }else{
    alert("‚ùå Error al registrar pedido: "+resp.error);
  }
}

/* ===========================
   Seguimiento de pedido (nuevo)
   =========================== */
function abrirSeguimiento(){
  const m = document.getElementById("modal-seguimiento");
  document.getElementById("resultado-seguimiento").style.display="none";
  document.getElementById("input-num-pedido").value="";
  m.style.display="block";
  setTimeout(()=>document.getElementById("input-num-pedido").focus(),50);
}
function cerrarSeguimiento(){document.getElementById("modal-seguimiento").style.display="none";}

async function consultarEstadoPedido(){
  const input = document.getElementById("input-num-pedido");
  const num = (input.value||"").trim();
  const box = document.getElementById("resultado-seguimiento");
  if(!num){ alert("Ingresa tu n√∫mero de pedido"); input.focus(); return; }
  box.style.display="block";
  box.textContent="Consultando...";

  try{
    const res = await fetch(`${API_URL}?numeroPedido=${encodeURIComponent(num)}`, {cache:"no-store"});
    const data = await res.json();
    const estado = data && data.pedidos && data.pedidos.estadoCliente;

    if(estado){
      box.textContent = `Estado del pedido N¬∞${num}: ${estado}`;
      // Guardamos para que el banner tambi√©n muestre el estado personalizado
      pedidoCliente = Number(num);
      actualizarBanner();
    }else{
      box.textContent = "No encontramos ese pedido. Revisa el n√∫mero.";
    }
  }catch(err){
    box.textContent = "Error consultando el estado. Intenta de nuevo.";
  }
}

// Enter para consultar
document.addEventListener("keydown", (e)=>{
  const m = document.getElementById("modal-seguimiento");
  if(m.style.display==="block" && e.key==="Enter"){
    consultarEstadoPedido();
  }
});

async function actualizarBanner(){
  try{
    let url=API_URL;
    if(pedidoCliente) url += `?numeroPedido=${pedidoCliente}`;
    const res = await fetch(url,{cache:"no-store"});
    const data = await res.json();
    const pedidos=data.pedidos||{};
    const banner=document.getElementById("pedido-banner");
    if(pedidoCliente && pedidos.estadoCliente){
      banner.textContent=`‚úÖ Tu pedido N¬∞${pedidoCliente} | Estado: ${pedidos.estadoCliente} | üî• Preparando Pedido: N¬∞${pedidos.pedidoEnPreparacion??"-"}`;
    }else{
      banner.textContent=`üî• Preparando Pedido: N¬∞${pedidos.pedidoEnPreparacion??"-"}`;
    }
  }catch(e){
    document.getElementById("pedido-banner").textContent="‚ö† Error cargando estado";
  }
}

setInterval(actualizarBanner,30000);

document.getElementById("search").addEventListener("input",mostrarProductos);
document.getElementById("filter-category").addEventListener("change",mostrarProductos);
document.querySelectorAll('input[name="metodoPago"]').forEach(r=>{
  r.addEventListener("change",()=>{
    document.getElementById("efectivo-box").style.display=r.value==="Efectivo"?"block":"none";
    document.getElementById("nequi-box").style.display=r.value==="Nequi"?"flex":"none";
  });
});

cargarProductos();
</script>
</body>
</html>
